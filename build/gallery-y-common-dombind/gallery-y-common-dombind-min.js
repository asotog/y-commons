YUI.add("gallery-y-common-dombind",function(Y,NAME){Y.namespace("Common");var ATTRIBUTE_SELECTOR="[{attributeName}]",LOOP_DATA_FILTER="|",FILTER=":",COMMA_SEPARATOR=",",DATA_BIND_CHANGE_EVENT="data-{property}-changed",DATA_IS_BINDED="-isbinded",TEMPLATE="-template",LOG_PREFIX="[Y.Common.DomBind] ",FIELD_TYPES={checkbox:0,radio:1},DATA_ARRAY="Array",SCOPE_VAR_TEMPLATE='var {scopeVarName} = scopeData["{scopeVarName}"];';Y.Common.DomBind=Y.Base.create("y-common-dombind",Y.Base,[],{initializer:function(){this._init()},setData:function(e,t,n){this._setData(e,t,n);var r=this._generateUniqueKey(e,n);this.fire(Y.Lang.sub(DATA_BIND_CHANGE_EVENT,{property:r}),{newValue:t})},listen:function(e,t){this.on(Y.Lang.sub(DATA_BIND_CHANGE_EVENT,{property:e}),function(e){t(e)})},_init:function(){var e=this;this.after("dataChange",function(){e._compileDirectives({})})},_compileDirectives:function(e){for(var t in Y.Common.DomBind.Directives)if(Y.Common.DomBind.Directives.hasOwnProperty(t)){var n=Y.Common.DomBind.Directives[t];this._compileAndExecuteDirective(e,t,n)}},_compileAndExecuteDirective:function(e,t,n){var r=this,i=e&&e.containerNode?e.containerNode:this.get("container"),s=e&&e.scopeData?e.scopeData:{},o=i.all(Y.Lang.sub(ATTRIBUTE_SELECTOR,{attributeName:this._getDirectiveName(t)})),u=Y.bind(n.directiveExecFn,this);o.each(function(e){Y.clone(u)(t,e,s)})},_tokenizeFilters:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n].split(FILTER);t.push({name:r[0],executeFn:r[1]})}return t},_doBeforeEachItem:function(e,t){for(var n=0;n<e.length;n++)if(e[n].name=="onBeforeEach"){var r=this.get("filters")[e[n].executeFn];t=r(t)}return t},_doAfterEachItem:function(e,t,n){for(var r=0;r<e.length;r++)if(e[r].name=="onAfterEach"){var i=this.get("filters")[e[r].executeFn];t=i(t,n)}},_setElementValue:function(e,t){if(e.get("localName")=="input"||e.get("localName")=="textarea"||e.get("localName")=="select"){var n=typeof FIELD_TYPES[e.get("type")]=="number"?FIELD_TYPES[e.get("type")]:e.get("type");switch(n){case FIELD_TYPES.checkbox:e.set("checked",t);break;case FIELD_TYPES.radio:e.set("checked",e.get("value")==t);break;default:e.set("value",t)}}else e.set("innerHTML",t)},_getElementValue:function(e){if(e.get("localName")=="input"||e.get("localName")=="textarea"||e.get("localName")=="select"){var t=typeof FIELD_TYPES[e.get("type")]=="number"?FIELD_TYPES[e.get("type")]:e.get("type");switch(t){case FIELD_TYPES.checkbox:return e.get("checked")}return e.get("value")}return null},_generateScopeVarsCode:function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t+=Y.Lang.sub(SCOPE_VAR_TEMPLATE,{scopeVarName:n}));return t},_generateUniqueKey:function(e,t){var n=e.split(".");if(n.length>1&&typeof t[n[0]]!="undefined"){var r=t[n[0]];e=(r._info&&r._info.parentType==DATA_ARRAY?r._info.parent+"."+r._info.index:"")+e}return e},_setData:function(bindKey,value,scopeData){var tokenizedKeys=bindKey.split(".");if(tokenizedKeys.length>1&&typeof scopeData[tokenizedKeys[0]]!="undefined"){var scopeItem=scopeData[tokenizedKeys[0]];if(scopeItem&&scopeItem._info&&scopeItem._info.parentType==DATA_ARRAY){tokenizedKeys.shift();var arrayItem=this.get("data")[scopeItem._info.parent][scopeItem._info.index];eval(this._generateObjectPropsAccessCode(tokenizedKeys,arrayItem));return}}if(tokenizedKeys.length>1&&typeof this.get("data")[tokenizedKeys[0]]!="undefined"){var scopeItem=scopeData[tokenizedKeys[0]];return}this.get("data")[bindKey]=value},_getData:function(e,t){var n=e.split(".");if(n.length>1&&typeof t[n[0]]!="undefined"){var r=t;for(var i=0;i<n.length;i++)r=r[n[i]];return r}return this.get("data")[e]},_generateObjectPropsAccessCode:function(e,t){var n='this.get("data")[scopeItem._info.parent][scopeItem._info.index]';return Y.Array.each(e,function(e){n+=Y.Lang.sub('["{property}"]',{property:e})}),n+" = value"},_getDirectiveName:function(e){return this.get("prefix")+e}},{ATTRS:{container:{value:null},data:{value:null},controller:{value:{}},filters:{value:{}},templates:{value:{}},prefix:{value:"data-db"}}}),Y.Common.DomBind.Directives={"-bind":{directiveExecFn:function(e,t,n){var r=t.getAttribute(this._getDirectiveName(e)),i=Y.clone(n);if(typeof t.getData(this.get("prefix")+DATA_IS_BINDED)=="undefined"){var s=this,o=this._generateUniqueKey(r,n);t.on(["keyup","change"],function(){s._getElementValue(t)!=t.getData("previousValue")&&(t.setData("previousValue",s._getElementValue(t)),s.setData(r,s._getElementValue(t),i))}),this.listen(o,function(e){t.setData("previousValue",e.newValue),s._setElementValue(t,e.newValue)}),t.setData(this.get("prefix")+DATA_IS_BINDED,!0)}this.setData(r,this._getData(r,n),i)}},"-onclick":{directiveExecFn:function(directiveName,el,scopeData){var me=this,val=el.getAttribute(this._getDirectiveName(directiveName)),methodName=val.split("(")[0];eval(me._generateScopeVarsCode(Y.clone(scopeData))),el.on("click",function(e){e.preventDefault(),eval(Y.Lang.sub('me.get("controller").{methodName} = Y.bind(me.get("controller").{methodName}, el);',{methodName:methodName})),eval('me.get("controller").'+val)})}},"-container-loop-data":{directiveExecFn:function(e,t,n){t.empty();var r=this,i=this.get("data"),s=t.getAttribute(this._getDirectiveName(e));s=s.split(LOOP_DATA_FILTER);var o=s.length>1?this._tokenizeFilters(s[1].split(COMMA_SEPARATOR)):[];s=s[0],s=s.match(/[^ ]+/g);var u=i[s[2]]&&i[s[2]].length>0?i[s[2]]:[],a=this.get("templates")[t.getAttribute(r._getDirectiveName(TEMPLATE))];Y.Array.each(u,function(e,i){var u=r._doBeforeEachItem(o,e),f=Y.Node.create(Y.Lang.sub(a,u)),l={containerNode:f,scopeData:n};u._info={parent:s[2],parentType:DATA_ARRAY,index:i},l.scopeData[s[0]]=u,r._compileDirectives(l),t.append(f),r._doAfterEachItem(o,e,f)})}}}},"@VERSION@",{requires:["yui-base","base-build","node"]});
