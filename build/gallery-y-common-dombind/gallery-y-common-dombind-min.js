YUI.add("gallery-y-common-dombind",function(Y,NAME){Y.namespace("Common");var ATTRIBUTE_SELECTOR="[{attributeName}]",LOOP_DATA_FILTER="|",FILTER=":",COMMA_SEPARATOR=",",DATA_BIND_CHANGE_EVENT="data-{property}-changed",DATA_IS_BINDED="-isbinded",TEMPLATE="-template",LOG_PREFIX="[Y.Common.DomBind] ",FIELD_TYPES={checkbox:0,radio:1},DATA_ARRAY="Array",SCOPE_VAR_TEMPLATE='var {scopeVarName} = scopeModel["{scopeVarName}"];';Y.Common.DomBind=Y.Base.create("gallery-y-common-dombind",Y.Base,[],{initializer:function(){this._init()},setModel:function(e,t,n,r){this._setModel(e,t,n);var i=this._generateUniqueKey(e,n);this.fire(Y.Lang.sub(DATA_BIND_CHANGE_EVENT,{property:i}),{newValue:t,triggerElement:r})},listen:function(e,t){this.on(Y.Lang.sub(DATA_BIND_CHANGE_EVENT,{property:e}),function(e){t(e)})},execControllerMethodExpression:function(code,scopeModel,el){var methodName=code.split("(")[0];eval(this._generateScopeVarsCode(scopeModel)),eval(Y.Lang.sub('this.get("controller").{methodName} = Y.bind(this.get("controller").{methodName}, el);',{methodName:methodName})),eval('this.get("controller").'+code)},_init:function(){var e=this;this.after("modelChange",function(){e._compileDirectives({})})},_compileDirectives:function(e){for(var t in Y.Common.DomBind.Directives)if(Y.Common.DomBind.Directives.hasOwnProperty(t)){var n=Y.Common.DomBind.Directives[t];this._compileAndExecuteDirective(e,t,n)}},_compileAndExecuteDirective:function(e,t,n){var r=this,i=e&&e.containerNode?e.containerNode:this.get("container"),s=e&&e.scopeModel?e.scopeModel:{},o=i.all(Y.Lang.sub(ATTRIBUTE_SELECTOR,{attributeName:this._getDirectiveName(t)})),u=Y.bind(n.directiveExecFn,this);o.each(function(e){Y.clone(u)(t,e,s)})},_tokenizeFilters:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n].split(FILTER);t.push({name:r[0],executeFn:r[1]})}return t},_doBeforeEachItem:function(e,t){for(var n=0;n<e.length;n++)if(e[n].name=="onBeforeEach"){var r=this.get("filters")[e[n].executeFn];t=r(t)}return t},_doAfterEachItem:function(e,t,n){for(var r=0;r<e.length;r++)if(e[r].name=="onAfterEach"){var i=this.get("filters")[e[r].executeFn];t=i(t,n)}},_setElementValue:function(e,t){var n=e.get("nodeName").toLowerCase();if(n=="input"||n=="textarea"||n=="select"){var r=typeof FIELD_TYPES[e.get("type")]=="number"?FIELD_TYPES[e.get("type")]:e.get("type");switch(r){case FIELD_TYPES.checkbox:e.set("checked",t);break;case FIELD_TYPES.radio:e.set("checked",e.get("value")==t);break;default:e.set("value",t)}}else e.set("innerHTML",t)},_getElementValue:function(e){var t=e.get("nodeName").toLowerCase();if(t=="input"||t=="textarea"||t=="select"){var n=typeof FIELD_TYPES[e.get("type")]=="number"?FIELD_TYPES[e.get("type")]:e.get("type");switch(n){case FIELD_TYPES.checkbox:return e.get("checked")}return e.get("value")}return null},_generateScopeVarsCode:function(e){var t="";for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];r&&r._info&&r._info.parentType==DATA_ARRAY?e[n]=this.get("model")[r._info.parent][r._info.index]:e[n]=this.get("model")[n],t+=Y.Lang.sub(SCOPE_VAR_TEMPLATE,{scopeVarName:n})}return t},_generateUniqueKey:function(e,t){var n=e.split(".");if(n.length>1&&typeof t[n[0]]!="undefined"){var r=t[n[0]];e=(r._info&&r._info.parentType==DATA_ARRAY?r._info.parent+"."+r._info.index:"")+e}return e},_setModel:function(bindKey,value,scopeModel){var tokenizedKeys=bindKey.split(".");if(tokenizedKeys.length>1&&typeof scopeModel[tokenizedKeys[0]]!="undefined"){var scopeItem=scopeModel[tokenizedKeys[0]];if(scopeItem&&scopeItem._info&&scopeItem._info.parentType==DATA_ARRAY){tokenizedKeys.shift();var arrayItem=this.get("model")[scopeItem._info.parent][scopeItem._info.index];eval(this._generateObjectPropsAccessCode(tokenizedKeys,arrayItem));return}}if(tokenizedKeys.length>1&&typeof this.get("model")[tokenizedKeys[0]]!="undefined"){var scopeItem=scopeModel[tokenizedKeys[0]];return}this.get("model")[bindKey]=value},_getModel:function(e,t){var n=e.split(".");if(n.length>1&&typeof t[n[0]]!="undefined"){var r=t;for(var i=0;i<n.length;i++)r=r[n[i]];return r}return this.get("model")[e]},_generateObjectPropsAccessCode:function(e,t){var n='this.get("model")[scopeItem._info.parent][scopeItem._info.index]';return Y.Array.each(e,function(e){n+=Y.Lang.sub('["{property}"]',{property:e})}),n+" = value"},_getDirectiveName:function(e){return this.get("prefix")+e}},{ATTRS:{container:{value:null},model:{value:null},controller:{value:{}},filters:{value:{}},templates:{value:{}},prefix:{value:"data-db"}}}),Y.Common.DomBind.Directives={"-bind":{directiveExecFn:function(e,t,n){var r=t.getAttribute(this._getDirectiveName(e)),i=Y.clone(n);if(typeof t.getData(this.get("prefix")+DATA_IS_BINDED)=="undefined"){var s=this,o=this._generateUniqueKey(r,n);t.on(["keyup","change","click"],function(){s._getElementValue(t)!=t.getData("previousValue")&&(t.setData("previousValue",s._getElementValue(t)),s.setModel(r,s._getElementValue(t),i,t))}),this.listen(o,function(e){if(typeof e.triggerElement=="undefined"||!e.triggerElement.compareTo(t))t.setData("previousValue",e.newValue),s._setElementValue(t,e.newValue)}),t.setData(this.get("prefix")+DATA_IS_BINDED,!0)}this.setModel(r,this._getModel(r,n),i)}},"-onclick":{directiveExecFn:function(e,t,n){var r=this,i=t.getAttribute(this._getDirectiveName(e)),s=Y.clone(n);t.on("click",function(e){e.preventDefault(),r.execControllerMethodExpression(i,s,t)})}},"-container-loop-model":{directiveExecFn:function(e,t,n){t.empty();var r=this,i=this.get("model"),s=t.getAttribute(this._getDirectiveName(e));s=s.split(LOOP_DATA_FILTER);var o=s.length>1?this._tokenizeFilters(s[1].split(COMMA_SEPARATOR)):[];s=s[0],s=s.match(/[^ ]+/g);var u=i[s[2]]&&i[s[2]].length>0?i[s[2]]:[],a=this.get("templates")[t.getAttribute(r._getDirectiveName(TEMPLATE))];Y.Array.each(u,function(e,i){var u=r._doBeforeEachItem(o,e),f=Y.Node.create(Y.Lang.sub(a,u)),l={containerNode:f,scopeModel:n};u._info={parent:s[2],parentType:DATA_ARRAY,index:i},l.scopeModel[s[0]]=u,r._compileDirectives(l),t.append(f),r._doAfterEachItem
(o,e,f)})}}}},"@VERSION@",{requires:["yui-base","base-build","node"]});
